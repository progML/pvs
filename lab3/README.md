# Лабораторная работа №3

## Задание

Разработать программу, которая помимо основного цикла while() в функции main() имеет еще
один поток управления, который отвечает за опрос клавиатуры. Необходимо настроить один
из таймеров микроконтроллера так, чтобы он регулярно генерировал прерывания в режиме
автоперезагрузки. В обработчике прерывания от данного таймера необходимо генерировать
посылки для обмена по шине I2C в режиме прерывания так, чтобы примерно каждые 50-100
миллисекунд происходил полный опрос клавиатуры. При этом должны выполняться
следующие требования:

- реализуется защита от дребезга;
- нажатие кнопки фиксируется сразу после того, как было обнаружено, что кнопка
нажата (с учетом защиты от дребезга), а не в момент отпускания кнопки; долгое
нажатие может фиксироваться отдельно;
- кнопка, которая удерживается дольше, чем один цикл опроса, не считается повторно
нажатой до тех пор, пока не будет отпущена;
- распознается и корректно обрабатывается множественное нажатие (при нажатии более
чем двух кнопок считается, что ни одна кнопка не нажата);
- всем кнопкам назначаются коды от 1 до 12 (порядок на усмотрение исполнителей);
- зафиксированные события нажатия кнопок помещаются в программный FIFO-буфер,
из которого их может считывать поток управления, работающий в главном цикле
функции main();
- доступ к буферу должен быть защищен от состояния гонки в моменты модификации
указателей критическими секциями с запретами прерываний.

В главном цикле функции main() выполняется основной поток управления, который может
работать в двух режимах, переключение между которыми производится по нажатию кнопки
на боковой панели стенда:
- режим тестирования клавиатуры;
- прикладной режим.

Уведомление о смене режима выводится в UART.

В режиме тестирования клавиатуры программа выводит в UART коды нажатых кнопок.

В прикладном режиме программа обрабатывает нажатия кнопок и выполняет действия в
соответствии с вариантом задания.

## Вариант 1

Реализовать «музыкальную клавиатуру» с помощью звукоизлучателя.
По нажатию кнопок клавиатуры выполняются следующие действия:
| Код кнопки | Действие |
|------------|----------|
| 1 – 7 | Воспроизводится нота (от «до» до «си») текущей октавы с текущей длительностью звучания. Начальные значения: первая октава, длительность 1 с. |
| 8     | Увеличить номер текущей октавы (максимальная – пятая). |
| 9     | Уменьшить номер текущей октавы (минимальная – субконтроктава). |
| 10    | Увеличить длительность звучания ноты на 0,1 с. |
| 11    | Уменьшить длительность звучания ноты на 0,1 с. |
| 12    | Последовательно воспроизвести все ноты текущей октавы с текущей длительностью без пауз. |

По нажатию каждой кнопки в UART должно выводиться сообщение о том, какая нота
проигрывается или новые значения параметров.

Существует 9 стандартных октав от субконтроктавы (первая по порядку) до пятой октавы
(девятая по порядку) (более подробно см. в сторонних источниках). Частоты нот в соседних
октавах отличаются ровно в 2 раза и растут с номером октавы. Частоты для первой октавы
(пятая по порядку):

| Нота | Частота, Гц |
|------|-------------|
| До | 261,63 |
| Ре | 293,67 |
| Ми | 329,63 |
| Фа | 349,23 |
| Соль | 392,00 |
| Ля | 440,00 |
| Си | 493,88 |